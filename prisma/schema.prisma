generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String   @default("ADMIN")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cardRechargeRecords       CardRechargeRecord[]
  reviewedAgentApplications AgentApplication[]

  @@map("users")
}

model Player {
  id          String    @id @default(cuid())
  userId      String    @unique // 6位數字，唯一
  nickname    String    // 允許重複，因為有 id、userId、lineUserId 作為唯一標識
  cardCount   Int       @default(0)
  avatarUrl   String? // 頭像URL
  bio         String? // 備註
  lineUserId  String?   @unique // LINE 使用者 ID
  lastLoginAt DateTime? // 最後登入時間
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  createdClubs           Club[]                  @relation("ClubCreator")
  clubMembers            ClubMember[]
  createdRooms           Room[]                  @relation("RoomCreator")
  cardRechargeRecords    CardRechargeRecord[]
  cardConsumptionRecords CardConsumptionRecord[]
  agentApplications      AgentApplication[]
  roomCardOrders         RoomCardOrder[]

  @@map("players")
}

model Club {
  id           String   @id @default(cuid())
  clubId       String   @unique // 6位數字，唯一
  name         String
  creatorId    String
  creator      Player   @relation("ClubCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  cardCount    Int      @default(0)
  avatarUrl    String?  // 俱樂部頭像URL (通常是創建者的頭像)
  gameSettings Json? // 俱樂部遊戲設定
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members ClubMember[]
  rooms   Room[]

  @@map("clubs")
}

model ClubMember {
  id       String   @id @default(cuid())
  clubId   String
  club     Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  playerId String
  player   Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())

  @@unique([clubId, playerId])
  @@map("club_members")
}

model Room {
  id             String   @id @default(cuid())
  roomId         String   @unique // 6位數字，唯一
  clubId         String?
  club           Club?    @relation(fields: [clubId], references: [id], onDelete: SetNull)
  creatorId      String
  creator        Player   @relation("RoomCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  currentPlayers Int      @default(0)
  maxPlayers     Int      @default(4)
  status         String   @default("WAITING") // WAITING, PLAYING, FINISHED
  gameSettings   Json? // 遊戲設定（JSON格式）
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("rooms")
}

model CardRechargeRecord {
  id            String   @id @default(cuid())
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  adminUserId   String
  adminUser     User     @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  amount        Int // 補卡數量
  previousCount Int // 補卡前的數量
  newCount      Int // 補卡後的數量
  createdAt     DateTime @default(now())

  @@map("card_recharge_records")
}

model CardConsumptionRecord {
  id            String   @id @default(cuid())
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  roomId        String? // 房間ID
  amount        Int // 消耗數量（通常為1）
  reason        String // 消耗原因：'game_end' (流局或胡牌)
  previousCount Int // 消耗前的數量
  newCount      Int // 消耗後的數量
  createdAt     DateTime @default(now())

  @@map("card_consumption_records")
}

model AgentApplication {
  id           String    @id @default(cuid())
  playerId     String
  player       Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  fullName     String
  email        String
  phone        String
  note         String?
  phoneOtpCode String
  emailOtpCode String
  status       String    @default("pending") // pending, approved, rejected
  reviewedAt   DateTime?
  reviewedBy   String? // 審核者 ID (User ID)
  reviewer     User?     @relation(fields: [reviewedBy], references: [id], onDelete: SetNull)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("agent_applications")
}

model Announcement {
  id             String   @id @default(cuid())
  announcementId String   @unique // 公告ID
  title          String // 標題
  content        String // 內容
  type           String // 類型: "活動" 或 "更新"
  isVisible      Boolean  @default(false) // 是否顯示
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("announcements")
}

model RoomCardProduct {
  id         String   @id @default(cuid())
  cardAmount Int      // 房卡數量
  price      Int      // 價格（新台幣）
  isActive   Boolean  @default(true) // 是否啟用
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  orders RoomCardOrder[]

  @@map("room_card_products")
}

model RoomCardOrder {
  id                String    @id @default(cuid())
  playerId          String
  player            Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  productId         String
  product           RoomCardProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  merchantTradeNo   String    @unique // 商店訂單編號
  ecpayTradeNo      String?   // 綠界交易編號
  cardAmount        Int       // 房卡數量
  price             Int       // 價格
  status            String    @default("PENDING") // PENDING, PAID, FAILED, CANCELLED
  paymentType       String?   // 付款方式
  virtualAccount    String?   // ATM 虛擬帳號
  bankCode          String?   // 銀行代碼
  expireDate        DateTime? // 繳費期限
  paidAt            DateTime? // 付款時間
  raw               Json?     // 原始資料
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("room_card_orders")
}
