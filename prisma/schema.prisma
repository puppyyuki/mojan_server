generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String   @default("ADMIN")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cardRechargeRecords CardRechargeRecord[]
  reviewedAgentApplications AgentApplication[]

  @@map("users")
}

model Player {
  id         String   @id @default(cuid())
  userId     String   @unique // 6位數字，唯一
  nickname   String   @unique
  cardCount  Int      @default(0)
  avatarUrl  String?  // 頭像URL
  bio        String?  // 備註
  lastLoginAt DateTime? // 最後登入時間
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  createdClubs           Club[]                  @relation("ClubCreator")
  clubMembers            ClubMember[]
  createdRooms           Room[]                  @relation("RoomCreator")
  cardRechargeRecords    CardRechargeRecord[]
  cardConsumptionRecords CardConsumptionRecord[]
  agentApplications      AgentApplication[]

  @@map("players")
}

model Club {
  id           String   @id @default(cuid())
  clubId       String   @unique // 6位數字，唯一
  name         String
  creatorId    String
  creator      Player   @relation("ClubCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  cardCount    Int      @default(0)
  gameSettings Json?    // 俱樂部遊戲設定
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members ClubMember[]
  rooms   Room[]

  @@map("clubs")
}

model ClubMember {
  id       String   @id @default(cuid())
  clubId   String
  club     Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  playerId String
  player   Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())

  @@unique([clubId, playerId])
  @@map("club_members")
}

model Room {
  id            String   @id @default(cuid())
  roomId        String   @unique // 6位數字，唯一
  clubId        String?
  club          Club?    @relation(fields: [clubId], references: [id], onDelete: SetNull)
  creatorId     String
  creator       Player   @relation("RoomCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  currentPlayers Int      @default(0)
  maxPlayers    Int      @default(4)
  status        String   @default("WAITING") // WAITING, PLAYING, FINISHED
  gameSettings  Json?    // 遊戲設定（JSON格式）
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("rooms")
}

model CardRechargeRecord {
  id          String   @id @default(cuid())
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  adminUserId String
  adminUser   User     @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  amount      Int      // 補卡數量
  previousCount Int    // 補卡前的數量
  newCount    Int      // 補卡後的數量
  createdAt   DateTime @default(now())

  @@map("card_recharge_records")
}

model CardConsumptionRecord {
  id          String   @id @default(cuid())
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  roomId      String?  // 房間ID
  amount      Int      // 消耗數量（通常為1）
  reason      String   // 消耗原因：'game_end' (流局或胡牌)
  previousCount Int    // 消耗前的數量
  newCount    Int      // 消耗後的數量
  createdAt   DateTime @default(now())

  @@map("card_consumption_records")
}

model AgentApplication {
  id          String   @id @default(cuid())
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  fullName    String
  email       String
  phone       String
  note        String?
  phoneOtpCode String
  emailOtpCode String
  status      String   @default("pending") // pending, approved, rejected
  reviewedAt  DateTime?
  reviewedBy  String?  // 審核者 ID (User ID)
  reviewer    User?    @relation(fields: [reviewedBy], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("agent_applications")
}
